#!/usr/bin/env bash

set -e

warn() { echo >&2 "$(basename $0):" "$@"; }
die()  { warn "$@"; exit 1; }

check_submodules() {
    count=$(git submodule status --recursive | sed -n -e '/^[^ ]/p' | wc -l)
    [ $count -eq 0 ] || {
        warn "$count Git submodules are not up to date"
        warn 'Run `git submodule update --init`?'
    }
}

############################################################
# Main

# Environment variables passed on to everything in build/test framework.
#
export base_dir="$(cd $(dirname "$0") && pwd -P)"
export build_dir="$base_dir/.build"
export build_t_dir="$build_dir/t"       # Data generated by tests

# Clear any data generated by previous test runs.
#
rm    -rf "$build_t_dir"
mkdir -p  "$build_t_dir"

cd "$base_dir"
check_submodules
tests=( $(find "$@" -name bats          -prune \
                 -o -name test_helper   -prune \
                 -o -name .git          -prune \
                 -o -name '*.bats'      -print) )
bats/bin/bats "${tests[@]}"
